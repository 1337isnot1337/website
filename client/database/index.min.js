import{downloadQuestionsAsText,downloadBonusesAsCSV,downloadTossupsAsCSV,downloadQuestionsAsJSON}from"./download.js";import api from"../scripts/api/index.js";import star from"../scripts/auth/star.js";import TossupCard from"../scripts/components/TossupCard.min.js";import BonusCard from"../scripts/components/BonusCard.min.js";import CategoryModal from"../scripts/components/CategoryModal.min.js";import DifficultyDropdown from"../scripts/components/DifficultyDropdown.min.js";import Star from"../scripts/components/Star.min.js";import{getDropdownValues}from"../scripts/utilities/dropdown-checklist.js";import CategoryManager from"../../quizbowl/category-manager.js";import insertTokensIntoHTML from"../../quizbowl/insert-tokens-into-html.js";const starredTossupIds=new Set(await star.getStarredTossupIds()),starredBonusIds=new Set(await star.getStarredBonusIds()),fontSize="true"===window.localStorage.getItem("database-font-size")?window.localStorage.getItem("font-size")??16:16,paginationShiftLength=992<window.screen.width?10:5,categoryManager=new CategoryManager;function arrayBetween(a,b){return Array(b-a).fill().map((b,c)=>a+c)}function getMatchIndices(a,b){const c=a.matchAll(b),d=[],e=[];for(let f=c.next();!1===f.done;)d.push(f.value.index),e.push(f.value.index+f.value[0].length),f=c.next();return{starts:d,ends:e}}function highlightTossupQuery({tossup:a,regExp:b,searchType:e="all",ignoreWordOrder:c,queryString:d}){const f=c?d.split(" ").filter(a=>""!==a).map(a=>new RegExp(a,"ig")):[b];for(const g of f){if("question"===e||"all"===e){const{starts:b,ends:c}=getMatchIndices(a.question_sanitized,g);a.question=insertTokensIntoHTML(a.question,a.question_sanitized,[b,c])}if("answer"===e||"all"===e){const{starts:b,ends:c}=getMatchIndices(a.answer_sanitized,g);a.answer=insertTokensIntoHTML(a.answer,a.answer_sanitized,[b,c])}}return a}function highlightBonusQuery({bonus:a,regExp:b,searchType:e="all",ignoreWordOrder:c,queryString:d}){const f=c?d.split(" ").filter(a=>""!==a).map(a=>new RegExp(a,"ig")):[b];for(const g of f){if("question"===e||"all"===e){{const{starts:b,ends:c}=getMatchIndices(a.leadin_sanitized,g);a.leadin=insertTokensIntoHTML(a.leadin,a.leadin_sanitized,[b,c])}for(let b=0;b<a.parts.length;b++){const{starts:c,ends:d}=getMatchIndices(a.parts_sanitized[b],g);a.parts[b]=insertTokensIntoHTML(a.parts[b],a.parts_sanitized[b],[c,d])}}if("answer"===e||"all"===e)for(let b=0;b<a.answers.length;b++){const{starts:c,ends:d}=getMatchIndices(a.answers_sanitized[b],g);a.answers[b]=insertTokensIntoHTML(a.answers[b],a.answers_sanitized[b],[c,d])}}return a}function QueryForm(){function a(){return Math.floor(1e4/(u||25))}/**
   *
   * @param {"tossup" | "bonus"} type - The type of question to handle pagination for.
   */function b(b,c,d){b.preventDefault();let f="tossup"===d?Z:_;const g={first:1,previous:Math.max(1,f-1),next:Math.min("tossup"===d?ba:da,f+1,a()),last:Math.min("tossup"===d?ba:da,a())};f=c in g?g[c]:c;const h=paginationShiftLength*Math.floor((f-1)/paginationShiftLength);"tossup"===d?(Z=f,$(f),ga(h)):(_=f,aa(f),ia(h)),e(b,!0),window.scrollTo({top:document.getElementById("tossup"===d?"tossups":"bonuses").offsetTop-100,behavior:"smooth"})}function c(a,c){return b(a,c,"tossup")}function d(a,c){return b(a,c,"bonus")}function e(a=null,b=!1){const c=window.performance.now();a?.preventDefault(),Y(!0),(G||!b)&&(Z=1,_=1,$(Z),aa(_));const d={queryString:s,...categoryManager.export(),difficulties:getDropdownValues("difficulties"),maxReturnLength:u,questionType:A,randomize:G,exactPhrase:N,caseSensitive:P,powermarkOnly:R,regex:J,ignoreWordOrder:L,searchType:y,setName:w,tossupPagination:1===Z?"":Z,bonusPagination:1===_?"":_,minYear:C,maxYear:E};delete d.categoryPercents;const e=Object.fromEntries(Object.entries(d).filter(([a,b])=>""!==b&&null!==b&&void 0!==b&&!1!==b&&!(Array.isArray(b)&&0===b.length)&&("questionType"!==a||"all"!==b)&&("searchType"!==a||"all"!==b))),f=new window.URLSearchParams(e);fetch(`/api/query?${f}`).then(a=>{if(400===a.status)throw new Error("Invalid query");return a}).then(a=>a.json()).then(a=>{const{tossups:b,bonuses:d,queryString:e}=a,h=RegExp(e,P?"g":"ig"),j=Math.max(1,u||25),{count:l,questionArray:n}=b,{count:p,questionArray:r}=d,t=JSON.parse(JSON.stringify(n)),v=JSON.parse(JSON.stringify(r));// create deep copy to highlight
if(""!==s){for(let a=0;a<t.length;a++)t[a]=highlightTossupQuery({tossup:t[a],regExp:h,searchType:y,ignoreWordOrder:L,queryString:s});for(let a=0;a<v.length;a++)v[a]=highlightBonusQuery({bonus:v[a],regExp:h,searchType:y,ignoreWordOrder:L,queryString:s})}o(l),g(n),k(t),q(p),i(r),m(v),G?(ca(1),ea(1)):(ca(Math.ceil(l/j)),ea(Math.ceil(p/j))),ga(paginationShiftLength*Math.floor((Z-1)/paginationShiftLength)),ia(paginationShiftLength*Math.floor((_-1)/paginationShiftLength));const w=window.performance.now(),x=((w-c)/1e3).toFixed(2);ka(x),window.history.pushState({tossups:b,highlightedTossupArray:t,bonuses:d,highlightedBonusArray:v,timeElapsed:x,workingMaxReturnLength:j,randomize:G},"","?"+f)}).catch(a=>{console.error("Error:",a),window.alert("Invalid query. Please check your search parameters and try again.")}).finally(()=>{document.querySelectorAll("b.collapsed[data-bs-toggle=\"collapse\"]").forEach(a=>a.classList.remove("collapsed")),document.querySelectorAll("div.card-container.collapse:not(.show)").forEach(a=>a.classList.add("show")),Y(!1)})}const[f,g]=React.useState([]),[h,i]=React.useState([]),[j,k]=React.useState([]),[l,m]=React.useState([]),[n,o]=React.useState(0),[p,q]=React.useState(0),r=new window.URLSearchParams(window.location.search),[s,t]=React.useState(r.get("queryString")??""),[u,v]=React.useState(r.get("maxReturnLength")??""),[w,x]=React.useState(r.get("setName")??""),[y,z]=React.useState(r.get("searchType")??"all"),[A,B]=React.useState(r.get("questionType")??"all"),[C,D]=React.useState(r.get("minYear")??""),[E,F]=React.useState(r.get("maxYear")??""),[G,H]=React.useState(r.get("randomize")??"false"),[I]=React.useState(/^\d+(,\d+)*$/.test(r.get("difficulties")??"")?(r.get("difficulties")??"").split(",").map(Number):getDropdownValues("difficulties"));// query form
console.log("difficulties:",I,typeof I);// toggleable options
const[J,K]=React.useState("true"===r.get("regex")),[L,M]=React.useState("true"===r.get("ignoreWordOrder")),[N,O]=React.useState("true"===r.get("exactPhrase")),[P,Q]=React.useState("true"===r.get("caseSensitive")),[R,S]=React.useState("true"===r.get("powermarkOnly")),[T,U]=React.useState(!1),[V,W]=React.useState(!1),[X,Y]=React.useState(!1);let[Z,$]=React.useState(1),[_,aa]=React.useState(1);const[ba,ca]=React.useState(1),[da,ea]=React.useState(1),[fa,ga]=React.useState(0),[ha,ia]=React.useState(0),[ja,ka]=React.useState(0),la=[];// paginationShift is one less than the first pagination number selectable
// so if the options are 11, 12, ..., 19, 20, then paginationShift=10
//    if the options are 86, 87, ..., 89, 90, then paginationShift=85
for(let a=0;a<j.length;a++){const b=f[a]._id,c=/*#__PURE__*/React.createElement(Star,{key:b,_id:b,questionType:"tossup",initiallyStarred:starredTossupIds.has(b)});la.push(/*#__PURE__*/React.createElement(TossupCard,{key:a,tossup:f[a],highlightedTossup:j[a],hideAnswerline:T,hideCardFooter:V,fontSize:fontSize,topRightComponent:c}))}const ma=[];for(let a=0;a<l.length;a++){const b=h[a]._id,c=/*#__PURE__*/React.createElement(Star,{key:b,_id:b,questionType:"bonus",initiallyStarred:starredBonusIds.has(b)});ma.push(/*#__PURE__*/React.createElement(BonusCard,{key:a,bonus:h[a],highlightedBonus:l[a],hideAnswerlines:T,hideCardFooter:V,fontSize:fontSize,topRightComponent:c}))}return React.useEffect(()=>{window.addEventListener("popstate",a=>{if(null===a.state)return o(0),g([]),k([]),q(0),i([]),m([]),ca(1),ea(1),ga(0),void ia(0);const{tossups:b,highlightedTossupArray:c,bonuses:d,highlightedBonusArray:e,timeElapsed:f,workingMaxReturnLength:h,randomize:j}=a.state,{count:l,questionArray:n}=b,{count:p,questionArray:r}=d;o(l),g(n),k(c),q(p),i(r),m(e),j?(ca(1),ea(1)):(ca(Math.ceil(l/h)),ea(Math.ceil(p/h))),ga(paginationShiftLength*Math.floor((Z-1)/paginationShiftLength)),ia(paginationShiftLength*Math.floor((_-1)/paginationShiftLength)),ka(f)}),document.getElementById("set-list").innerHTML=api.getSetList().map(a=>`<option>${a}</option>`).join(""),""!==window.location.search&&e()},[]),/*#__PURE__*/React.createElement("div",null,/*#__PURE__*/React.createElement(CategoryModal,{categoryManager:categoryManager,disablePercentView:!0}),/*#__PURE__*/React.createElement("form",{className:"mt-3",onSubmit:a=>{e(a)}},/*#__PURE__*/React.createElement("div",{className:"input-group mb-2"},/*#__PURE__*/React.createElement("input",{type:"text",className:"form-control",id:"query",placeholder:"Query",value:s,onChange:a=>{t(a.target.value)}}),/*#__PURE__*/React.createElement("button",{type:"submit",className:"btn btn-info"},"Search"),/*#__PURE__*/React.createElement("button",{id:"randomize",className:"btn btn-success",onClick:a=>{H(!0),e(a)}},"Random")),/*#__PURE__*/React.createElement("div",{className:"row"},/*#__PURE__*/React.createElement("div",{className:"col-6 col-xl-3 mb-2"},/*#__PURE__*/React.createElement(DifficultyDropdown,{startingDifficulties:I})),/*#__PURE__*/React.createElement("div",{className:"col-6 col-xl-3 mb-2"},/*#__PURE__*/React.createElement("input",{type:"number",className:"form-control",id:"max-return-length",placeholder:"# to Display",value:u,onChange:a=>{v(a.target.value)}})),/*#__PURE__*/React.createElement("div",{className:"input-group col-12 col-xl-6 mb-2"},/*#__PURE__*/React.createElement("input",{type:"text",className:"form-control",id:"set-name",placeholder:"Set Name",list:"set-list",value:w,onChange:a=>{x(a.target.value)}}),/*#__PURE__*/React.createElement("datalist",{id:"set-list"}),/*#__PURE__*/React.createElement("button",{type:"button",className:"btn btn-danger",id:"category-select-button","data-bs-toggle":"modal","data-bs-target":"#category-modal"},"Categories"))),/*#__PURE__*/React.createElement("div",{className:"row"},/*#__PURE__*/React.createElement("div",{className:"col-6 col-md-3 mb-2"},/*#__PURE__*/React.createElement("select",{className:"form-select",id:"search-type",value:y,onChange:a=>{z(a.target.value)}},/*#__PURE__*/React.createElement("option",{value:"all"},"All text"),/*#__PURE__*/React.createElement("option",{value:"question"},"Question"),/*#__PURE__*/React.createElement("option",{value:"answer"},"Answer"))),/*#__PURE__*/React.createElement("div",{className:"col-6 col-md-3 mb-2"},/*#__PURE__*/React.createElement("select",{className:"form-select",id:"question-type",value:A,onChange:a=>{B(a.target.value)}},/*#__PURE__*/React.createElement("option",{value:"all"},"All questions"),/*#__PURE__*/React.createElement("option",{value:"tossup"},"Tossups"),/*#__PURE__*/React.createElement("option",{value:"bonus"},"Bonuses"))),/*#__PURE__*/React.createElement("div",{className:"col-6 col-md-3 mb-2"},/*#__PURE__*/React.createElement("input",{type:"number",className:"form-control",id:"min-year",placeholder:"Min Year",value:C,onChange:a=>{D(a.target.value)}})),/*#__PURE__*/React.createElement("div",{className:"col-6 col-md-3 mb-2"},/*#__PURE__*/React.createElement("input",{type:"number",className:"form-control",id:"max-year",placeholder:"Max Year",value:E,onChange:a=>{F(a.target.value)}}))),/*#__PURE__*/React.createElement("div",{className:"row"},/*#__PURE__*/React.createElement("div",{className:"col-12"},/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-regex",checked:J,onChange:()=>{K(!J)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-regex"},"Search using regular expression"),/*#__PURE__*/React.createElement("a",{href:"https://www.sitepoint.com/learn-regex/"}," What's this?")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-ignore-word-order",checked:!J&&L,disabled:J,onChange:()=>{M(!L)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-ignore-word-order"},"Ignore word order")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-exact-phrase",checked:!J&&N,disabled:J,onChange:()=>{O(!N)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-exact-phrase"},"Search for exact phrase")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-case-sensitive",checked:P,onChange:()=>{Q(!P)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-case-sensitive"},"Case sensitive search")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-powermark-only",checked:R,onChange:()=>{S(!R)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-powermark-only"},"Powermarked tossups only")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-hide-answerlines",checked:T,onChange:()=>{U(!T)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-hide-answerlines"},"Hide answerlines")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-hide-card-footers",checked:V,onChange:()=>{W(!V)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-hide-card-footers"},"Hide card footers")),/*#__PURE__*/React.createElement("div",{className:"float-end"},/*#__PURE__*/React.createElement("b",null,"Download this page:"),/*#__PURE__*/React.createElement("a",{className:"ms-2 clickable",onClick:()=>{downloadQuestionsAsText(f,h)}},"TXT"),/*#__PURE__*/React.createElement("a",{className:"ms-2 clickable",onClick:()=>{downloadTossupsAsCSV(f),downloadBonusesAsCSV(h)}},"CSV"),/*#__PURE__*/React.createElement("a",{className:"ms-2 clickable",onClick:()=>{downloadQuestionsAsJSON(f,h)}},"JSON"))))),X&&/*#__PURE__*/React.createElement("div",{className:"d-block mx-auto mt-3 spinner-border",role:"status"},/*#__PURE__*/React.createElement("span",{className:"d-none"},"Loading...")),/*#__PURE__*/React.createElement("div",{className:"row text-center mt-2 mt-sm-0"},/*#__PURE__*/React.createElement("h3",{id:"tossups"},"Tossups")),0<n?/*#__PURE__*/React.createElement("div",{className:"float-row mb-3"},/*#__PURE__*/React.createElement("span",{className:"text-muted float-start"},"Showing ",f.length," of ",n," results (",ja," seconds)"),"\xA0",/*#__PURE__*/React.createElement("span",{className:"text-muted float-end"},/*#__PURE__*/React.createElement("a",{className:"clickable",onClick:()=>window.scrollTo({top:document.getElementById("bonuses").offsetTop,behavior:"smooth"})},"Jump to bonuses")))// eslint-disable-line
:/*#__PURE__*/React.createElement("div",{className:"text-muted"},"No tossups found"),/*#__PURE__*/React.createElement("div",null,la),1<ba&&/*#__PURE__*/React.createElement("nav",{"aria-label":"tossup nagivation"},/*#__PURE__*/React.createElement("ul",{className:"pagination justify-content-center"},/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"First",onClick:a=>{c(a,"first")}},"\xAB")),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Previous",onClick:a=>{c(a,"previous")}},"\u2039")),arrayBetween(Math.min(fa),Math.min(fa+paginationShiftLength,ba)).map(a=>{const b=Z===a+1;return/*#__PURE__*/React.createElement("li",{key:`tossup-pagination-${a+1}`,className:"page-item"},/*#__PURE__*/React.createElement("a",{className:`page-link ${b&&"active"}`,href:"#",onClick:b=>{c(b,a+1)}},a+1))}),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Next",onClick:a=>{c(a,"next")}},"\u203A")),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Last",onClick:a=>{c(a,"last")}},/*#__PURE__*/React.createElement("span",{"aria-hidden":"true"},"\xBB"))))),/*#__PURE__*/React.createElement("div",{className:"mb-5"}),/*#__PURE__*/React.createElement("div",{className:"row text-center"},/*#__PURE__*/React.createElement("h3",{id:"bonuses"},"Bonuses")),0<p?/*#__PURE__*/React.createElement("div",{className:"float-row mb-3"},/*#__PURE__*/React.createElement("span",{className:"text-muted float-start"},"Showing ",h.length," of ",p," results (",ja," seconds)"),"\xA0",/*#__PURE__*/React.createElement("span",{className:"text-muted float-end"},/*#__PURE__*/React.createElement("a",{className:"clickable",onClick:()=>window.scrollTo({top:document.getElementById("tossups").offsetTop,behavior:"smooth"})},"Jump to tossups")))// eslint-disable-line
:/*#__PURE__*/React.createElement("div",{className:"text-muted"},"No bonuses found"),/*#__PURE__*/React.createElement("div",null,ma),1<da&&/*#__PURE__*/React.createElement("nav",{"aria-label":"bonus nagivation"},/*#__PURE__*/React.createElement("ul",{className:"pagination justify-content-center"},/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"First",onClick:a=>{d(a,"first")}},"\xAB")),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Previous",onClick:a=>{d(a,"previous")}},"\u2039")),arrayBetween(Math.min(ha),Math.min(ha+paginationShiftLength,da)).map(a=>{const b=_===a+1;return/*#__PURE__*/React.createElement("li",{key:`bonus-pagination-${a+1}`,className:"page-item"},/*#__PURE__*/React.createElement("a",{className:`page-link ${b&&"active"}`,href:"#",onClick:b=>{d(b,a+1)}},a+1))}),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Next",onClick:a=>{d(a,"next")}},"\u203A")),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Last",onClick:a=>{d(a,"last")}},/*#__PURE__*/React.createElement("span",{"aria-hidden":"true"},"\xBB"))))),/*#__PURE__*/React.createElement("div",{className:"mb-5"}))}const root=ReactDOM.createRoot(document.getElementById("root"));root.render(/*#__PURE__*/React.createElement(QueryForm,null)),document.getElementById("report-question-submit").addEventListener("click",function(){api.reportQuestion(document.getElementById("report-question-id").value,document.getElementById("report-question-reason").value,document.getElementById("report-question-description").value)});